import zipfile
import json
import numpy as np
from tqdm import tqdm

file = zipfile.ZipFile("/home/srivasta/khan0586/Documents/timeline-data/split_n2_test_full.zip")
namelist = file.namelist()

print(len(namelist))

user_trust = {}

#reading first 2 files

for name in tqdm(namelist[1:]): #skip the first one as it is just directory name
    #This will iterate over each file in the archive and print out its name, length and the first 10 bytes.
    #print("filename: " + name + "\n")
    
    #******processing data in one file*******
    data = file.read(name)
#     data_str=repr(data)
    data_str = data.decode('utf-8')
    
    curr_username = ""
    retweet_count = 0
    src_count = 0
    src_retweets_count = 0

    #****processing each line of file
    for line in data_str.splitlines(): #the first line contains the user features, the subsequesnt lines contain tweets
        #print(line)
        json_dict = json.loads(line) #converting to json so that can be easily accessed like a dictionary
        #print(json_dict) #printing the line 

        if ("tweet_type" in json_dict.keys()): 
            if (json_dict["tweet_type"] == "retweet_without_comment" or json_dict["tweet_type"] == "retweet_with_comment"):
                retweet_count += 1
            elif (json_dict["tweet_type"] == "source_tweet"):
                src_count += 1
                src_retweets_count += json_dict["primary_tweet"]["retweet_count"]
        else:
            curr_username = json_dict["screen_name"]

        #else:
            #if ("tweet_type" in json_dict.keys()):
                ##print(json_dict['tweet_type'])
                # if (json_dict["tweet_type"] == "reply"):
                #     with open('reply.json', 'w') as f:
                #         json.dump(json_dict, f)
                # elif (json_dict["tweet_type"] == "retweet_without_comment"):
                #     with open('rt_comment.json', 'w') as f:
                #         json.dump(json_dict, f)
                # elif (json_dict["tweet_type"] == "retweet_with_comment"):
                #     with open('rt_no_comment.json', 'w') as f:
                #         json.dump(json_dict, f)
                # elif (json_dict["tweet_type"] == "source_tweet"):
                #     with open('source_tweet.json', 'w') as f:
                #         json.dump(json_dict, f)

    trust_others = 0 if retweet_count + src_count == 0 else retweet_count / (retweet_count + src_count)
    other_trust_self = 0 if src_count == 0 else src_retweets_count / src_count
    #print("trusting others:", trust_others)
    #print("trusted by others:", other_trust_self)
    user_trust[curr_username] = {"trusting_others": trust_others, "trusted_by_others": other_trust_self}

with open("local_trust_N2.json", 'w') as file:
    json.dump(user_trust, file)
